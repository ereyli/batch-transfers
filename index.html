<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/png" href="https://www.sendwise.xyz/.well-known/icon.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, viewport-fit=cover, user-scalable=no, shrink-to-fit=no" />
    <meta name="format-detection" content="telephone=no" />

    <title>Sendwise - Smart Batch Transfers</title>

    <!-- Farcaster Mini App Open Graph Metadata -->
    <meta property="og:title" content="Sendwise - Smart Batch Transfers" />
    <meta property="og:description" content="Send ETH and ERC20 tokens to multiple addresses in a single transaction. Save gas, save time with smart batch transfers." />
    <meta property="og:image" content="https://www.sendwise.xyz/.well-known/hero-image.png" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://www.sendwise.xyz/" />
    <meta property="og:site_name" content="Sendwise" />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:locale" content="en_US" />
    <meta property="og:determiner" content="the" />

    <!-- Twitter Meta Tags -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Sendwise - Smart Batch Transfers" />
    <meta name="twitter:description" content="Send ETH and ERC20 tokens to multiple addresses in a single transaction. Save gas, save time with smart batch transfers." />
    <meta name="twitter:url" content="https://www.sendwise.xyz/" />
    <meta name="twitter:image" content="https://www.sendwise.xyz/.well-known/hero-image.png" />

    <meta name="description" content="Send ETH and ERC20 tokens to multiple addresses in a single transaction. Save gas, save time with smart batch transfers." />
    <meta name="keywords" content="batch transfer, ethereum, defi, wallet, gas savings, airdrop, payroll, bulk payments, sendwise" />
    <meta name="author" content="Sendwise Team" />
    <meta name="robots" content="index, follow" />
        <meta name="theme-color" content="#1a1a1a" />

    <!-- Farcaster Frame Meta Tags -->
    <meta name="fc:frame" content="vNext" />
    <meta name="fc:frame:image" content="https://www.sendwise.xyz/.well-known/hero-image.png" />
    <meta name="fc:frame:button:1" content="🚀 Start Batch Transfer" />
    <meta name="fc:frame:button:1:action" content="link" />
    <meta name="fc:frame:button:1:target" content="https://www.sendwise.xyz" />
    
    <!-- Farcaster Mini App Manifest -->
    <link rel="farcaster_manifest" href="https://www.sendwise.xyz/.well-known/farcaster.json" />
    
    <!-- Meta tags for Farcaster Frame -->
    <meta name="fc:frame:post_url" content="https://www.sendwise.xyz" />
    <meta name="fc:frame:input:text" content="Enter amount..." />
    
    <!-- Early Farcaster SDK Detection -->
    <script>
      // Early detection and SDK setup
      (function() {
        const userAgent = navigator.userAgent || '';
        const referrer = document.referrer || '';
        
        // Balanced detection - allow mobile Farcaster app
        const isFarcasterUA = userAgent.toLowerCase().includes('farcaster') || 
                             userAgent.toLowerCase().includes('warpcast');
        const isFarcasterReferrer = referrer.includes('warpcast.com') || 
                                   referrer.includes('farcaster.xyz');
        const isInFrame = window !== window.top;
        const isMobile = /Mobile|Android|iPhone|iPad/.test(userAgent);
        
        // Farcaster if: (User Agent + Referrer) OR (User Agent + Frame) OR (Mobile + User Agent)
        const isFarcaster = (isFarcasterUA && isFarcasterReferrer) || 
                           (isFarcasterUA && isInFrame) || 
                           (isMobile && isFarcasterUA);
        
        if (isFarcaster) {
          console.log('Early Farcaster detection: true', {
            userAgent: userAgent,
            referrer: referrer,
            isFarcasterUA: isFarcasterUA,
            isFarcasterReferrer: isFarcasterReferrer,
            isInFrame: isInFrame,
            isMobile: isMobile
          });
          window.isFarcasterMiniApp = true;
          
          // Comprehensive error suppression for Farcaster analytics
          const originalConsoleError = console.error;
          console.error = function(...args) {
            const message = args.join(' ');
            const suppressPatterns = [
              'Failed to resolve module specifier',
              '@farcaster/frame-core',
              'Relative references must start with',
              'privy.farcaster.xyz',
              'CORS',
              'ERR_BLOCKED_BY_CLIENT',
              'dd-proxy',
              'datadog',
              'X-Frame-Options',
              'chromewebdata',
              'csp-report.browser-intake-datadoghq.com',
              'warpcast.com/~/dd-proxy',
              'farcaster.xyz/~/dd-proxy',
              'Expected length',
              'attribute width',
              'attribute height',
              'svg',
              'Bad Request',
              'Backpack',
              'window.ethereum',
              'ERR_TIMED_OUT',
              'Failed to fetch',
              'ERR_CONNECTION_CLOSED',
              'ERR_INTERNET_DISCONNECTED',
              'ERR_NAME_NOT_RESOLVED',
              'WebSocket connection',
              'Farcaster API Error',
              'Cannot set property ethereum',
              'Cannot redefine property',
              'isZerion',
              'getDesktopListings',
              'getRecomendedWallets',
              'preloadListings',
              'Port connected',
              'Failed to set window.ethereum',
              'Missing catch or finally after try',
              'Uncaught SyntaxError',
              'SyntaxError',
              'openWalletModal is not a function',
              'addInput is not defined',
              'MetaMask encountered an error',
              'setting the global Ethereum provider',
              'another Ethereum wallet extension',
              'Cannot set property ethereum',
              'which has only a getter',
              'Uncaught (in promise) TypeError',
              'Cannot redefine property',
              'override `window.ethereum`',
              'Access to script at',
              'has been blocked by CORS policy',
              'No \'Access-Control-Allow-Origin\' header'
            ];
            
            if (suppressPatterns.some(pattern => message.includes(pattern))) {
              // Suppress analytics and framing errors
              return;
            }
            originalConsoleError.apply(console, args);
          };
          
          // Also suppress network errors
          const originalFetch = window.fetch;
          window.fetch = function(...args) {
            const url = args[0];
            if (typeof url === 'string' && (
              url.includes('dd-proxy') || 
              url.includes('datadog') || 
              url.includes('csp-report')
            )) {
              return Promise.resolve(new Response('{}', { status: 200 }));
            }
            return originalFetch.apply(this, args);
          };
          
          // Try to call ready as soon as possible if SDK is available
          const tryReady = () => {
            const sdk = window.farcasterSDK || window.farcaster || window.fc || 
                       window.parent?.farcasterSDK || window.parent?.farcaster || window.parent?.fc;
            
            if (sdk) {
              console.log('Early SDK found:', typeof sdk, Object.keys(sdk));
              
              // If it's the raw farcaster SDK, try to use it directly
              if (sdk === window.farcaster) {
                console.log('Using raw Farcaster SDK');
                try {
                  // Just log that we have the SDK - no need to call ready() here
                  console.log('Raw Farcaster SDK available, will initialize later');
                } catch (e) {
                  console.log('Early SDK error:', e);
                }
              } else if (sdk.actions && sdk.actions.ready) {
                console.log('Early SDK ready() call');
                sdk.actions.ready().catch(e => {
                  if (!e.message?.includes('privy.farcaster.xyz')) {
                    console.log('Early ready() error:', e);
                  }
                });
              }
            }
          };
          
          // Try immediately and also on DOM ready
          tryReady();
          document.addEventListener('DOMContentLoaded', tryReady);
        } else {
          // Explicitly set as false for web context
          console.log('Early detection: Not in Farcaster Mini App (web context)');
          window.isFarcasterMiniApp = false;
          
          // Additional check for injected Farcaster SDK in web context
          setTimeout(() => {
            if (window.farcaster && !window.isFarcasterMiniApp) {
              console.log('Farcaster SDK detected in web context, but keeping web mode');
              // Don't change isFarcasterMiniApp, just acknowledge the SDK exists
            }
          }, 1000);
        }
        
        // Emergency loading hide for Farcaster
        if (isFarcaster) {
          // Multiple fallback timers for white screen prevention
          setTimeout(() => {
            const loadingElement = document.getElementById('loading');
            if (loadingElement && loadingElement.style.display !== 'none') {
              loadingElement.style.display = 'none';
              console.log('Emergency loading screen hide in Farcaster (2s)');
              
              // Force show main content
              const mainContent = document.querySelector('.container');
              if (mainContent) {
                mainContent.style.display = 'block';
                mainContent.style.visibility = 'visible';
                mainContent.style.opacity = '1';
              }
            }
          }, 2000); // 2 second fallback
          
          // Even more aggressive fallback
          setTimeout(() => {
            document.body.style.visibility = 'visible';
            document.body.style.opacity = '1';
            console.log('Emergency body visibility fix');
          }, 1000);
        }
      })();
    </script>

    <!-- Safe Area CSS -->
    <style>
      :root {
        --safe-area-inset-top: env(safe-area-inset-top);
        --safe-area-inset-bottom: env(safe-area-inset-bottom);
        --safe-area-inset-left: env(safe-area-inset-left);
        --safe-area-inset-right: env(safe-area-inset-right);
      }

      body {
        margin: 0;
        padding: 0;
        background: #1a1a1a;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        overflow-x: hidden;
        -webkit-text-size-adjust: 100%;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -webkit-tap-highlight-color: transparent;
        color: #ffffff;
      }

      #root {
        min-height: 100vh;
        padding-top: var(--safe-area-inset-top);
        padding-bottom: var(--safe-area-inset-bottom);
        padding-left: var(--safe-area-inset-left);
        padding-right: var(--safe-area-inset-right);
      }

      input, textarea, select {
        font-size: 16px !important;
      }

      * {
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }

      input, textarea, [contenteditable] {
        -webkit-user-select: text;
        -moz-user-select: text;
        -ms-user-select: text;
        user-select: text;
      }

      .loading {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        background: linear-gradient(135deg, #1a1a1a 0%, #2d1b69 100%);
      }

      .spinner {
        width: 50px;
        height: 50px;
        border: 3px solid #667eea;
        border-top: 3px solid transparent;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>
    
    <!-- Structured Data for SEO -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "Sendwise",
    "description": "Smart Batch Transfers for ETH & ERC20 Tokens",
    "url": "https://www.sendwise.xyz",
    "applicationCategory": "FinanceApplication",
    "operatingSystem": "Web Browser, Farcaster Mini App",
    "offers": {
      "@type": "Offer",
      "price": "0",
      "priceCurrency": "USD"
    },
    "creator": {
      "@type": "Organization",
      "name": "Sendwise Team"
    }
  }
  </script>
  
  <!-- Twitter Card Meta Tags -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Sendwise - Smart Batch Transfers" />
  <meta name="twitter:description" content="Send ETH & ERC20 tokens to multiple addresses in a single transaction. Save gas, save time!" />
      <meta name="twitter:image" content="https://www.sendwise.xyz/.well-known/hero-image.png" />
  
  <!-- Ethers.js -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  
  <!-- Wagmi and Viem for Farcaster Mini App -->
  <script src="https://cdn.jsdelivr.net/npm/viem@2.23.15/dist/viem.umd.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/wagmi@2.5.7/dist/wagmi.umd.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@farcaster/miniapp-wagmi-connector@0.1.0/dist/index.umd.js"></script>
  

  
  <!-- Fonts and Styles -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles/main.css">
</head>
<body>
  <div id="root">
    <!-- Loading Screen - Enhanced for Farcaster Mini App -->
    <div id="loading" class="loading" style="display: none;">
      <div class="loading-content">
        <div class="loading-logo">
          <img src="https://www.sendwise.xyz/.well-known/logo.png" alt="Sendwise Logo" />
        </div>
        <div class="loading-spinner"></div>
        <h3>🚀 Sendwise</h3>
        <p>Smart Batch Transfers</p>
        <div class="loading-subtitle">Connecting to Farcaster...</div>
      </div>
    </div>

    <div class="container">
    <!-- Header -->
    <div class="header fade-in">
      <div class="logo">
        <img src="https://www.sendwise.xyz/.well-known/logo.png" alt="Sendwise Logo" />
      </div>
      <h1>Sendwise</h1>
      <p class="subtitle">Smart Batch Transfers for ETH & ERC20 Tokens</p>
      <div class="supported-networks" id="networkTags" style="display: flex; gap: 8px; flex-wrap: wrap; justify-content: center;">
        <button class="network-tag" data-chain="8453" style="padding: 6px 10px; border-radius: 999px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.06); color: #fff; font-size: 12px; cursor: pointer;">Base</button>
        <button class="network-tag" data-chain="10" style="padding: 6px 10px; border-radius: 999px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.06); color: #fff; font-size: 12px; cursor: pointer;">Optimism</button>
        <button class="network-tag" data-chain="42161" style="padding: 6px 10px; border-radius: 999px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.06); color: #fff; font-size: 12px; cursor: pointer;">Arbitrum</button>
        <button class="network-tag" data-chain="1" style="padding: 6px 10px; border-radius: 999px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.06); color: #fff; font-size: 12px; cursor: pointer;">Ethereum</button>
      </div>
      
      <!-- Wallet Button - Below Logo (Only shown in web browser) -->
      <div id="walletButtonContainer" style="margin-top: 20px; text-align: center;">
        <button id="headerWalletBtn" onclick="window.openWalletModal()" style="
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          border: none;
          border-radius: 12px;
          padding: 12px 24px;
          font-size: 14px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s ease;
          box-shadow: 0 4px 16px rgba(102, 126, 234, 0.4);
          font-family: 'Inter', sans-serif;
          min-width: 160px;
        ">
          <span style="font-size: 16px;">💳</span>
          <span>Connect Wallet</span>
        </button>
      </div>
    </div>

    <!-- Farcaster Info -->
    <div id="farcasterInfo" class="farcaster-info" style="display:none;">
      <!-- Farcaster info removed - focus on wallet connection -->
    </div>

    <!-- Main Form -->
    <div class="main-form slide-up">
      <div class="form-group">
        <label class="form-label">Transfer Type</label>
        <select id="transferType" class="form-select">
          <option value="eth">ETH Transfer</option>
          <option value="erc20">ERC20 Token Transfer</option>
        </select>
      </div>

      <div class="form-group" id="tokenAddressRow" style="display:none;">
        <label class="form-label">Token Contract Address</label>
        <input type="text" id="tokenAddressInput" class="form-input" placeholder="0x..." />
      </div>

      <div id="tokenInfo" class="token-info" style="display:none;"></div>

      <!-- Recipients Section -->
      <div class="recipients-section">
        <div class="recipients-header">
          <h3 class="recipients-title">Recipients</h3>
        </div>

        <div id="inputContainer">
          <div class="recipient-row">
            <input type="text" placeholder="Recipient Address (0x...)" class="form-input address" />
            <input type="text" placeholder="Amount" class="form-input amount" />
            <div class="recipient-actions">
              <button onclick="addInput()" class="recipient-action-btn add-recipient-btn" title="Add Recipient">
                ➕
              </button>
              <button onclick="removeLast()" class="recipient-action-btn remove-recipient-btn" title="Remove Last" disabled>
                ❌
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="action-buttons">
        <button id="approveBtn" style="display:none;" onclick="approveToken()" class="btn btn-primary">
          ✅ Approve Token
        </button>
        <button id="sendBtn" style="display:none;" onclick="sendBatch()" class="btn btn-primary">
          🚀 Send Batch Transfer
        </button>
      </div>

      <div id="status" class="status" style="display:none;"></div>
    </div>

    <!-- CSV Import Section -->
    <div class="csv-section slide-up">
      <h3>📁 Import Wallets via CSV</h3>
      <div class="file-input-wrapper">
        <input type="file" id="walletCsvInput" accept=".csv" class="file-input" />
        <label for="walletCsvInput" class="file-input-label">
          📄 Choose CSV File
        </label>
      </div>
      <button onclick="importWallets()" class="btn btn-secondary">
        ➕ Import Wallets
      </button>
    </div>
  </div>
</div>

  <!-- Farcaster Mini App SDK -->
  <script type="module" src="https://cdn.jsdelivr.net/npm/@farcaster/frame-sdk@latest/dist/sdk.js" defer></script>
  <script type="module">
    import { SendwiseApp } from './js/app.js';

    // Global variables
    window.isFarcasterMiniApp = false;
    
    // Wait for Farcaster SDK to load
    async function waitForFarcasterSDK() {
      // Check for injected Farcaster SDK (most common)
      if (typeof window.farcaster !== 'undefined') {
        console.log('Farcaster SDK loaded:', window.farcaster);
        
        try {
          const sdk = window.farcaster;
          
          // Check available methods
          console.log('SDK methods available:', Object.keys(sdk));
          
          // Try to get context information
          if (sdk.context) {
            console.log('SDK context available:', sdk.context);
          }
          
          // Setup SDK wrapper
          window.farcasterSDK = {
            actions: {
              ready: async () => {
                console.log('SDK ready() called');
                return true;
              }
            },
            wallet: sdk.wallet || sdk,
            context: sdk.context || sdk,
            raw: sdk // Keep reference to raw SDK
          };
          
          return true;
        } catch (error) {
          console.log('Farcaster SDK initialization error:', error);
          return false;
        }
      }
      
      // Check for Frame SDK
      if (typeof window.FrameSDK !== 'undefined') {
        console.log('Farcaster Frame SDK detected:', window.FrameSDK);
        
        try {
          const sdk = window.FrameSDK;
          await sdk.context.ready();
          console.log('Frame SDK initialized and ready');
          
          window.farcasterSDK = {
            actions: { ready: async () => true },
            wallet: sdk.wallet,
            context: sdk.context
          };
          
          return true;
        } catch (error) {
          console.log('Frame SDK initialization error:', error);
          return false;
        }
      }
      
      // Check for alternative patterns
      if (typeof window.fc !== 'undefined') {
        console.log('Alternative Farcaster SDK detected:', window.fc);
        window.farcasterSDK = window.fc;
        return true;
      }
      
      return false;
    }

    // Global wallet modal function
    window.openWalletModal = () => {
      console.log('openWalletModal called');
      
      if (window.walletManager) {
        window.walletManager.showModernWalletModal();
      } else {
        console.error('WalletManager not available');
        // Avoid alert in sandboxed iframe
        if (window.uiManager) {
          window.uiManager.updateStatus('Wallet system not initialized. Please refresh the page.', false, true);
        }
      }
    };

    // Initialize Wagmi for Farcaster Mini App
    function initializeWagmi() {
      try {
        if (window.wagmi && window.viem && window.FarcasterMiniAppConnector) {
          console.log('Initializing Wagmi for Farcaster Mini App...');
          
          // Create Wagmi config with Base as primary chain
          const config = window.wagmi.createConfig({
            chains: [
              { id: 8453, name: 'Base' },
              { id: 10, name: 'Optimism' },
              { id: 42161, name: 'Arbitrum' },
              { id: 1, name: 'Ethereum' }
            ],
            transports: {
              8453: window.wagmi.http('https://mainnet.base.org'),
              10: window.wagmi.http('https://mainnet.optimism.io'),
              42161: window.wagmi.http('https://arb1.arbitrum.io/rpc'),
              1: window.wagmi.http('https://eth.llamarpc.com')
            },
            connectors: [
              window.FarcasterMiniAppConnector.farcasterMiniApp()
            ]
          });
          
          // Create Wagmi client
          window.wagmiClient = window.wagmi.createClient(config);
          
          console.log('Wagmi initialized successfully');
          // Expose config for potential chain switching helpers
          window.wagmiConfig = config;
          return true;
        } else {
          console.warn('Wagmi libraries not available');
          return false;
        }
      } catch (error) {
        console.error('Error initializing Wagmi:', error);
        return false;
      }
    }

    // Initialize Farcaster Mini App
    async function initializeFarcasterMiniApp() {
      try {
        console.log('Initializing Farcaster Mini App...');
        
        // Check if we're in Farcaster environment
        if (window.isFarcasterMiniApp) {
          console.log('Running in Farcaster Mini App environment');
          
          // First, try to initialize Farcaster SDK
          const sdkReady = await waitForFarcasterSDK();
          console.log('SDK initialization result:', sdkReady);
          
                // Set up Farcaster-specific UI adjustments immediately
      setupFarcasterUI();
      
      // Keep wallet button visible for manual connection
      const walletButtonContainer = document.getElementById('walletButtonContainer');
      if (walletButtonContainer) {
        walletButtonContainer.style.display = 'block';
      }
          
          // Initialize Wagmi for Farcaster Mini App if SDK is ready
          if (sdkReady) {
          const wagmiInitialized = initializeWagmi();
            console.log('Wagmi initialized:', wagmiInitialized);
          }
          
          if (wagmiInitialized && window.wagmiClient) {
            console.log('Wagmi initialized successfully for Farcaster Mini App');
            
            // Check if user is already connected
            try {
              const { data: account } = await window.wagmiClient.getAccount();
              if (account && account.address) {
                console.log('User already connected:', account.address);
                // Update UI to show connected state
                if (typeof updateWalletDisplay === 'function') {
                  updateWalletDisplay(account.address, 'Farcaster Wallet', 'Farcaster', 'farcaster');
                }
              } else {
                console.log('User not connected, will need to connect');
              }
            } catch (error) {
              console.warn('Could not check account status:', error);
            }
          }
          
        } else {
          console.log('Running in web browser environment');
          // Show loading screen for web browser
          const loadingElement = document.getElementById('loading');
          if (loadingElement) {
            loadingElement.style.display = 'flex';
          }
        }
        
      } catch (error) {
        console.error('Error initializing Farcaster Mini App:', error);
      }
    }

    // Setup clickable network tags (user selects sending network by tapping a tag)
    function setupNetworkTags() {
      // Default selected chain is Base
      if (!window.selectedChainId) {
        window.selectedChainId = 8453;
      }
      const container = document.getElementById('networkTags');
      if (!container) return;
      const tags = container.querySelectorAll('.network-tag');

      function highlightSelected() {
        tags.forEach(tag => {
          const isActive = Number(tag.dataset.chain) === Number(window.selectedChainId);
          tag.style.background = isActive ? 'rgba(102, 126, 234, 0.3)' : 'rgba(255,255,255,0.06)';
          tag.style.border = isActive ? '1px solid rgba(102,126,234,0.8)' : '1px solid rgba(255,255,255,0.2)';
        });
      }

      async function trySwitchChain(chainId) {
        try {
          if (window.wagmiClient && typeof window.wagmiClient.switchChain === 'function') {
            await window.wagmiClient.switchChain({ chainId });
            console.log('Switched chain via Wagmi to', chainId);
            return true;
          }
        } catch (err) {
          console.warn('switchChain not available or failed:', err);
        }
        return false;
      }

      tags.forEach(tag => {
        tag.addEventListener('click', async () => {
          const chainId = Number(tag.dataset.chain);
          window.selectedChainId = chainId;
          highlightSelected();
          // Attempt to switch chain if supported
          await trySwitchChain(chainId);
          // Inform managers if available
          if (window.walletManager && typeof window.walletManager.updateMainConnectButton === 'function') {
            const address = await (window.walletManager.getAddress?.() || Promise.resolve(''));
            const networkNameMap = { 1: 'Ethereum', 10: 'Optimism', 42161: 'Arbitrum', 8453: 'Base' };
            const networkName = networkNameMap[chainId] || 'Network';
            window.walletManager.updateMainConnectButton(address || '', 'Farcaster Wallet', networkName, 'farcaster');
          }
        });
      });

      // Initial highlight
      highlightSelected();
    }

    // Setup Farcaster-specific UI adjustments (SDK-free)
    function setupFarcasterUI() {
      
      // Hide wallet button in Farcaster Mini App
      const walletButtonContainer = document.getElementById('walletButtonContainer');
      if (walletButtonContainer) {
        walletButtonContainer.style.display = 'none';
      }
      
      // Adjust header for mobile
      const header = document.querySelector('.header');
      if (header) {
        header.style.paddingTop = '60px'; // Account for Farcaster header
      }
      
      // Add Farcaster-specific styles
      const style = document.createElement('style');
      style.textContent = `
        .farcaster-mode .header {
          padding-top: 60px;
        }
        
        .farcaster-mode .container {
          max-width: 100%;
          padding: 0 16px;
        }
        
        .farcaster-mode .main-form {
          margin-top: 20px;
        }
        
        .farcaster-mode .recipients-section {
          margin-top: 20px;
        }
        
        .farcaster-mode .csv-section {
          margin-top: 30px;
        }
        
        /* Prevent content reflow */
        .farcaster-mode * {
          box-sizing: border-box;
        }
        
        /* Optimize for mobile touch */
        .farcaster-mode button {
          min-height: 44px;
          touch-action: manipulation;
        }
        
        .farcaster-mode input {
          min-height: 44px;
          touch-action: manipulation;
        }
      `;
      document.head.appendChild(style);
      
      // Add Farcaster mode class to body
      document.body.classList.add('farcaster-mode');
    }

    // Placeholder function - not needed for basic wallet connection
    async function addToCollection() {
      console.log('Add to Collection function called');
    }

    // Initialize app when DOM is loaded
    window.addEventListener('DOMContentLoaded', async function() {
      try {
        console.log('Initializing Sendwise app...');
        
        // Initialize Farcaster Mini App first
        await initializeFarcasterMiniApp();

        // Setup network tag handlers
        setupNetworkTags();
        
        // Initialize Sendwise app
        const app = new SendwiseApp();
        window.sendwiseApp = app;
        window.walletManager = app.getWalletManager();
        
        console.log('Sendwise app initialized successfully');
        
        // Hide loading screen for all contexts
          const loadingElement = document.getElementById('loading');
          if (loadingElement) {
            loadingElement.style.display = 'none';
          console.log('Loading screen hidden after app initialization');
        }
        
      } catch (error) {
        console.error('Failed to initialize app:', error);
        
        // Hide loading screen even on error
          const loadingElement = document.getElementById('loading');
          if (loadingElement) {
            loadingElement.style.display = 'none';
          console.log('Loading screen hidden after error');
        }
        
        // Show error message only in web browser
        if (!window.isFarcasterMiniApp && window.uiManager) {
          window.uiManager.updateStatus('Failed to initialize. Please refresh the page.', false, true);
        }
      }
    });
  </script>
  
  <!-- Global Error Handler for SVG and other errors -->
  <script>
    // Comprehensive global error handler
    window.addEventListener('error', function(e) {
      const errorPatterns = [
        'Failed to resolve module specifier',
        '@farcaster/frame-core',
        'Relative references must start with',
        'Unsupported APPLY for',
        'Missing catch or finally after try',
        'Uncaught SyntaxError',
        'SyntaxError',
        'Expected length',
        'attribute width',
        'attribute height',
        'svg',
        'openWalletModal is not a function',
        'addInput is not defined',
        'ERR_BLOCKED_BY_CLIENT',
        'Bad Request',
        'dd-proxy',
        'datadog',
        'csp-report',
        'Backpack',
        'window.ethereum',
        'ERR_TIMED_OUT',
        'Failed to fetch',
        'ERR_CONNECTION_CLOSED',
        'ERR_INTERNET_DISCONNECTED',
        'ERR_NAME_NOT_RESOLVED',
        'WebSocket connection',
        'Farcaster API Error',
        'Cannot set property ethereum',
        'Cannot redefine property',
        'isZerion',
        'getDesktopListings',
        'getRecomendedWallets',
        'preloadListings',
        'Port connected',
        'Failed to set window.ethereum',
        'MetaMask encountered an error',
        'setting the global Ethereum provider',
        'another Ethereum wallet extension',
        'which has only a getter',
        'override `window.ethereum`',
        'Access to script at',
        'has been blocked by CORS policy',
        'No \'Access-Control-Allow-Origin\' header'
      ];
      
      if (e.message && errorPatterns.some(pattern => e.message.includes(pattern))) {
        console.log('Suppressed error:', e.message);
        e.preventDefault();
        return false;
      }
    });
    
    // Unhandled promise rejection handler
    window.addEventListener('unhandledrejection', function(e) {
      const errorMessage = e.reason?.message || e.reason || '';
      const errorPatterns = [
        'Failed to resolve module specifier',
        '@farcaster/frame-core',
        'Relative references must start with',
        'Unsupported APPLY for',
        'Missing catch or finally after try',
        'Uncaught SyntaxError',
        'SyntaxError',
        'openWalletModal is not a function',
        'addInput is not defined',
        'ERR_BLOCKED_BY_CLIENT',
        'Bad Request',
        'dd-proxy',
        'datadog',
        'csp-report',
        'Failed to fetch',
        'analytics',
        'ERR_TIMED_OUT',
        'ERR_CONNECTION_CLOSED',
        'ERR_INTERNET_DISCONNECTED',
        'ERR_NAME_NOT_RESOLVED',
        'WebSocket connection',
        'Farcaster API Error',
        'Cannot set property ethereum',
        'Cannot redefine property',
        'getDesktopListings',
        'getRecomendedWallets',
        'preloadListings',
        'MetaMask encountered an error',
        'setting the global Ethereum provider',
        'another Ethereum wallet extension',
        'which has only a getter',
        'override `window.ethereum`',
        'Access to script at',
        'has been blocked by CORS policy',
        'No \'Access-Control-Allow-Origin\' header'
      ];
      
      if (errorPatterns.some(pattern => errorMessage.includes(pattern))) {
        console.log('Suppressed promise rejection:', errorMessage);
        e.preventDefault();
        return false;
      }
    });
    
    // Override console.error to filter out known Farcaster SDK errors
    const originalConsoleError = console.error;
    console.error = function(...args) {
      const message = args.join(' ');
      if (message.includes('Expected length') && message.includes('svg')) {
        console.log('Suppressed SVG error:', message);
        return;
      }
      if (message.includes('X-Frame-Options') && message.includes('deny')) {
        console.log('Suppressed X-Frame-Options error:', message);
        return;
      }
      originalConsoleError.apply(console, args);
    };
  </script>

  <!-- Farcaster Mini App SDK - Must be at the bottom of HTML file -->
  <script type="module">
    import { sdk } from 'https://esm.sh/@farcaster/miniapp-sdk'
    
    // Global SDK reference
    window.farcasterSDK = sdk;
    
    // Initialize SDK immediately
    (async () => {
      try {
        console.log('Farcaster SDK loaded:', sdk);
        
        // Check if we're in Farcaster environment
        // Since we already detected Farcaster context in early detection, proceed with setup
        console.log('Farcaster SDK loaded, setting up Mini App environment');
        window.isFarcasterMiniApp = true;
        
                        // Try to call ready using actions.ready() method (most common in Frame SDK)
        try {
          if (typeof sdk.actions?.ready === 'function') {
            await sdk.actions.ready();
            console.log('Farcaster SDK actions.ready() called successfully');
          } else if (typeof sdk.ready === 'function') {
            await sdk.ready();
            console.log('Farcaster SDK ready() called successfully');
          } else {
            console.log('No ready method found on SDK, proceeding without calling ready');
            console.log('Available SDK methods:', Object.keys(sdk));
          }
          
          // Now that SDK is ready, trigger wallet auto-connection with retries
          console.log('SDK ready - triggering Farcaster wallet auto-connection');
          
          // Direct wallet connection after SDK ready
          const tryDirectWalletConnection = async () => {
            console.log('Attempting direct wallet connection with SDK');
            
            try {
              // Try to get wallet directly from the ready SDK
              if (typeof sdk.wallet?.getWallet === 'function') {
                const wallet = await sdk.wallet.getWallet();
                console.log('Direct SDK wallet:', wallet);
                if (wallet && wallet.address) {
                  console.log('Direct wallet connection successful:', wallet.address);
                  
                                    // Update UI immediately with the connected wallet
                  if (window.uiManager && typeof window.uiManager.updateWalletDisplay === 'function') {
                    window.uiManager.updateWalletDisplay(wallet.address, 'Farcaster Wallet', 'Farcaster', 'farcaster');
                    console.log('UI updated with Farcaster wallet address');
          } else {
                    console.log('UI Manager not available - using direct DOM update');
                    
                    // Direct DOM update for wallet display
                    const walletBtn = document.getElementById('headerWalletBtn');
                    if (walletBtn) {
                      const shortAddress = wallet.address.slice(0, 6) + '...' + wallet.address.slice(-4);
                      walletBtn.innerHTML = `
                        <span style="color: white; font-size: 14px;">🟣 ${shortAddress}</span>
                      `;
                      walletBtn.style.background = 'linear-gradient(135deg, #6366f1, #8b5cf6)';
                      console.log('Direct DOM wallet update successful');
                    }
                    
                    // Hide loading and show main content
                    const loadingScreen = document.getElementById('loadingScreen');
                    if (loadingScreen) {
                      loadingScreen.style.display = 'none';
                      console.log('Loading screen hidden via direct DOM');
                    }
                    
                    const mainContent = document.getElementById('mainContent');
                    if (mainContent) {
                      mainContent.style.display = 'block';
                      console.log('Main content shown via direct DOM');
                    }
                    
                    // Show send button if hidden
                    const sendButton = document.getElementById('sendButton');
                    if (sendButton) {
                      sendButton.style.display = 'block';
                      console.log('Send button shown via direct DOM');
                    }
                    
                    // Define addInput function if not available
                    if (typeof window.addInput === 'undefined') {
                      window.addInput = () => {
                        console.log('Direct addInput called - adding recipient row');
                        const recipientsContainer = document.getElementById('recipients');
                        if (recipientsContainer) {
                          const newRow = document.createElement('div');
                          newRow.className = 'recipient-row';
                          newRow.innerHTML = \`
                            <input type="text" class="form-input" placeholder="Recipient Address" style="background: #2a2a2a !important; color: white !important;">
                            <input type="number" class="form-input" placeholder="Amount" step="0.000001" style="background: #2a2a2a !important; color: white !important;">
                            <button onclick="this.parentElement.remove()" class="recipient-action-btn remove-recipient-btn" title="Remove Recipient">×</button>
                          \`;
                          recipientsContainer.appendChild(newRow);
                          console.log('Recipient row added via direct DOM');
                        }
                      };
                      console.log('Direct addInput function defined');
                    }
                  }
                  
                  // Also try to set the wallet in wallet manager if available
                    if (window.walletManager) {
                      window.walletManager.currentWalletType = 'farcaster';
                      console.log('Wallet manager updated with Farcaster type');
                    }
                    
                    // Hide loading screen since wallet is connected
                    if (window.uiManager && typeof window.uiManager.hideLoading === 'function') {
                      window.uiManager.hideLoading();
                      console.log('Loading screen hidden after wallet connection');
                    }
                    
                    return true;
                }
              }
              
              // Try to get provider from SDK
              if (typeof sdk.wallet?.getEthereumProvider === 'function') {
                const provider = await sdk.wallet.getEthereumProvider();
                if (provider) {
                  const accounts = await provider.request({ method: 'eth_accounts' });
                  if (accounts && accounts.length > 0) {
                    console.log('Direct provider connection successful:', accounts[0]);
                    
                                        // Update UI immediately with the connected wallet
                    if (window.uiManager && typeof window.uiManager.updateWalletDisplay === 'function') {
                      window.uiManager.updateWalletDisplay(accounts[0], 'Farcaster Wallet', 'Farcaster', 'farcaster');
                      console.log('UI updated with Farcaster wallet address');
        } else {
                      console.log('UI Manager not available - using direct DOM update');
                      
                      // Direct DOM update for wallet display
                      const walletBtn = document.getElementById('headerWalletBtn');
                      if (walletBtn) {
                        const shortAddress = accounts[0].slice(0, 6) + '...' + accounts[0].slice(-4);
                        walletBtn.innerHTML = `
                          <span style="color: white; font-size: 14px;">🟣 ${shortAddress}</span>
                        `;
                        walletBtn.style.background = 'linear-gradient(135deg, #6366f1, #8b5cf6)';
                        console.log('Direct DOM wallet update successful');
                      }
                      
                      // Hide loading and show main content
                      const loadingScreen = document.getElementById('loadingScreen');
                      if (loadingScreen) {
                        loadingScreen.style.display = 'none';
                        console.log('Loading screen hidden via direct DOM');
                      }
                      
                      const mainContent = document.getElementById('mainContent');
                      if (mainContent) {
                        mainContent.style.display = 'block';
                        console.log('Main content shown via direct DOM');
                      }
                      
                      // Show send button if hidden
                      const sendButton = document.getElementById('sendButton');
                      if (sendButton) {
                        sendButton.style.display = 'block';
                        console.log('Send button shown via direct DOM');
                      }
                      
                      // Define addInput function if not available
                      if (typeof window.addInput === 'undefined') {
                        window.addInput = () => {
                          console.log('Direct addInput called - adding recipient row');
                          const recipientsContainer = document.getElementById('recipients');
                          if (recipientsContainer) {
                            const newRow = document.createElement('div');
                            newRow.className = 'recipient-row';
                            newRow.innerHTML = \`
                              <input type="text" class="form-input" placeholder="Recipient Address" style="background: #2a2a2a !important; color: white !important;">
                              <input type="number" class="form-input" placeholder="Amount" step="0.000001" style="background: #2a2a2a !important; color: white !important;">
                              <button onclick="this.parentElement.remove()" class="recipient-action-btn remove-recipient-btn" title="Remove Recipient">×</button>
                            \`;
                            recipientsContainer.appendChild(newRow);
                            console.log('Recipient row added via direct DOM');
                          }
                        };
                        console.log('Direct addInput function defined');
                      }
                    }
                    
                    // Also try to set the wallet in wallet manager if available
                    if (window.walletManager) {
                      window.walletManager.currentWalletType = 'farcaster';
                      console.log('Wallet manager updated with Farcaster type');
                    }
                    
                    // Hide loading screen since wallet is connected
                    if (window.uiManager && typeof window.uiManager.hideLoading === 'function') {
                      window.uiManager.hideLoading();
                      console.log('Loading screen hidden after wallet connection');
                    }
                    
                    return true;
                  }
                }
              }
            } catch (error) {
              console.log('Direct wallet connection failed:', error.message);
            }
            
            return false;
          };
          
          // Try direct connection first
          const directSuccess = await tryDirectWalletConnection();
          
          if (!directSuccess) {
            // Fallback to wallet manager when available
            const tryWalletManager = async (attempt = 1, maxAttempts = 8) => {
              console.log(`Wallet manager attempt ${attempt}/${maxAttempts}`);
              
              if (window.walletManager && typeof window.walletManager.initializeFarcasterMiniAppWallet === 'function') {
                console.log('Wallet manager found - initializing Farcaster wallet');
                try {
                  await window.walletManager.initializeFarcasterMiniAppWallet();
                  console.log('Wallet manager initialization successful');
                  return true;
                } catch (error) {
                  console.log('Wallet manager initialization failed:', error.message);
                }
              } else {
                console.log('Wallet manager not available yet...');
              }
              
              if (attempt < maxAttempts) {
                setTimeout(() => tryWalletManager(attempt + 1, maxAttempts), 1000);
              } else {
                console.log('Max wallet manager attempts reached');
              }
              return false;
            };
            
            // Start wallet manager attempts
            setTimeout(() => tryWalletManager(), 200);
            setTimeout(() => tryWalletManager(), 800);
            setTimeout(() => tryWalletManager(), 2000);
          }
          
        } catch (e) {
          console.log('SDK ready call failed, but continuing:', e.message);
        }
      } catch (error) {
        console.error('Error initializing Farcaster SDK:', error);
        window.isFarcasterMiniApp = false;
      }
    })();
  </script>
</body>
</html>
