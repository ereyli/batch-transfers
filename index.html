<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sendwise: Smart Batch Transfers</title>
  <link rel="icon" href="https://bafybeigudidkz2nstogywhcb6gbwicvfdfqgkrdhjsnlvll5esa6hzic4e.ipfs.w3s.link/logo.png" type="image/png" />
     <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
   <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
   <link rel="stylesheet" href="styles/main.css">
</head>
<body>
  <div id="loading" class="loading">
    <div class="loading-spinner"></div>
    <h3>🚀 Initializing Sendwise...</h3>
    <p>Connecting to Farcaster and Web3 networks...</p>
  </div>

  <div class="container">
    <!-- Header with Wallet Button -->
    <div class="header fade-in" style="position: relative;">
      <!-- Wallet Button - Top Right -->
      <div style="position: absolute; top: 20px; right: 20px; z-index: 1000;">
        <button id="headerWalletBtn" onclick="console.log('Header button clicked!'); console.log('openWalletModal:', window.openWalletModal); if(window.openWalletModal) window.openWalletModal(); else alert('openWalletModal not found!');" style="
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          border: none;
          border-radius: 12px;
          padding: 12px 24px;
          font-size: 14px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s ease;
          box-shadow: 0 4px 16px rgba(102, 126, 234, 0.4);
          font-family: 'Inter', sans-serif;
          min-width: 160px;
        ">
          <span style="font-size: 16px;">🌈</span>
          <span>Connect Wallet</span>
        </button>
      </div>
      
      <div class="logo">
        <img src="https://bafybeigudidkz2nstogywhcb6gbwicvfdfqgkrdhjsnlvll5esa6hzic4e.ipfs.w3s.link/logo.png" alt="Sendwise Logo" />
      </div>
      <h1>Sendwise</h1>
      <p class="subtitle">Smart Batch Transfers for ETH & ERC20 Tokens</p>
      <div class="supported-networks">
        <div class="network-icon"></div>
        <span>Base • Optimism • Arbitrum • Soneium • Unichain • Ink</span>
      </div>
    </div>



    <!-- Farcaster Info -->
    <div id="farcasterInfo" class="farcaster-info" style="display:none;">
      <strong>🚀 Farcaster Mini App Mode</strong><br>
      Connected to Farcaster ecosystem with enhanced wallet integration
    </div>



    <!-- Main Form -->
    <div class="main-form slide-up">
      <div class="form-group">
        <label class="form-label">Transfer Type</label>
        <select id="transferType" class="form-select">
          <option value="eth">ETH Transfer</option>
          <option value="erc20">ERC20 Token Transfer</option>
        </select>
      </div>

      <div class="form-group" id="tokenAddressRow" style="display:none;">
        <label class="form-label">Token Contract Address</label>
        <input type="text" id="tokenAddressInput" class="form-input" placeholder="0x..." />
      </div>

      <div id="tokenInfo" class="token-info" style="display:none;"></div>

      <!-- Recipients Section -->
      <div class="recipients-section">
        <div class="recipients-header">
          <h3 class="recipients-title">Recipients</h3>
        </div>

        <div id="inputContainer">
          <div class="recipient-row">
            <input type="text" placeholder="Recipient Address (0x...)" class="form-input address" />
            <input type="text" placeholder="Amount" class="form-input amount" />
            <div class="recipient-actions">
                             <button onclick="addInput()" class="recipient-action-btn add-recipient-btn" title="Add Recipient">
                 ➕
               </button>
               <button onclick="removeLast()" class="recipient-action-btn remove-recipient-btn" title="Remove Last" disabled>
                 ❌
               </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="action-buttons">
        <button id="approveBtn" style="display:none;" onclick="approveToken()" class="btn btn-primary">
          ✅ Approve Token
        </button>
        <button id="sendBtn" style="display:none;" onclick="sendBatch()" class="btn btn-primary">
          🚀 Send Batch Transfer
        </button>
      </div>

      <div id="status" class="status" style="display:none;"></div>
    </div>

    <!-- CSV Import Section -->
    <div class="csv-section slide-up">
      <h3>📁 Import Wallets via CSV</h3>
      <div class="file-input-wrapper">
        <input type="file" id="walletCsvInput" accept=".csv" class="file-input" />
        <label for="walletCsvInput" class="file-input-label">
          📄 Choose CSV File
        </label>
      </div>
      <button onclick="importWallets()" class="btn btn-secondary">
        ➕ Import Wallets
      </button>
    </div>
  </div>

  <script type="module">
    import { SendwiseApp } from './js/app.js';

    // Global wallet modal function - Define immediately
    window.openWalletModal = () => {
      console.log('openWalletModal called - Creating modal directly');
      
      // Create modal directly
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
        backdrop-filter: blur(8px);
      `;

      const modalContent = document.createElement('div');
      modalContent.style.cssText = `
        background: white;
        border-radius: 20px;
        padding: 32px;
        max-width: 480px;
        width: 90%;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        font-family: 'Inter', sans-serif;
      `;

      modalContent.innerHTML = `
        <div style="text-align: center; margin-bottom: 32px;">
          <h2 style="margin: 0 0 8px 0; font-size: 24px; font-weight: 700; color: #1a1a1a;">Connect Wallet</h2>
          <p style="margin: 0; color: #666; font-size: 16px;">Choose your preferred wallet</p>
        </div>
        
        <div style="display: flex; flex-direction: column; gap: 12px;">
          <button onclick="connectMetaMask(); closeModal();" style="
            display: flex; align-items: center; gap: 12px; padding: 16px; border: 2px solid #f0f0f0; 
            border-radius: 12px; background: white; cursor: pointer; transition: all 0.2s ease;
            font-size: 16px; font-weight: 600; color: #1a1a1a; text-align: left; width: 100%;
            font-family: 'Inter', sans-serif;
          ">
            <span style="font-size: 24px;">🦊</span>
            <div>
              <div>MetaMask</div>
              <div style="font-size: 14px; font-weight: 400; color: #666; margin-top: 2px;">Connect with MetaMask</div>
            </div>
          </button>
          
          <button onclick="connectWalletConnect(); closeModal();" style="
            display: flex; align-items: center; gap: 12px; padding: 16px; border: 2px solid #f0f0f0; 
            border-radius: 12px; background: white; cursor: pointer; transition: all 0.2s ease;
            font-size: 16px; font-weight: 600; color: #1a1a1a; text-align: left; width: 100%;
            font-family: 'Inter', sans-serif;
          ">
            <span style="font-size: 24px;">🔗</span>
            <div>
              <div>WalletConnect</div>
              <div style="font-size: 14px; font-weight: 400; color: #666; margin-top: 2px;">Connect with mobile wallet</div>
            </div>
          </button>
          
          <button onclick="connectCoinbase(); closeModal();" style="
            display: flex; align-items: center; gap: 12px; padding: 16px; border: 2px solid #f0f0f0; 
            border-radius: 12px; background: white; cursor: pointer; transition: all 0.2s ease;
            font-size: 16px; font-weight: 600; color: #1a1a1a; text-align: left; width: 100%;
            font-family: 'Inter', sans-serif;
          ">
            <span style="font-size: 24px;">🪙</span>
            <div>
              <div>Coinbase Wallet</div>
              <div style="font-size: 14px; font-weight: 400; color: #666; margin-top: 2px;">Connect with Coinbase Wallet</div>
            </div>
          </button>
          
          <button onclick="detectAndConnect(); closeModal();" style="
            display: flex; align-items: center; gap: 12px; padding: 16px; border: 2px solid #667eea; 
            border-radius: 12px; background: #f8f9ff; cursor: pointer; transition: all 0.2s ease;
            font-size: 16px; font-weight: 600; color: #667eea; text-align: left; width: 100%;
            font-family: 'Inter', sans-serif;
          ">
            <span style="font-size: 24px;">🔍</span>
            <div>
              <div>Auto Detect</div>
              <div style="font-size: 14px; font-weight: 400; color: #667eea; margin-top: 2px;">Automatically detect installed wallets</div>
            </div>
          </button>
        </div>
        
        <button onclick="closeModal()" style="
          margin-top: 24px; width: 100%; padding: 12px; border: none; border-radius: 12px; 
          background: #f0f0f0; color: #666; font-size: 16px; font-weight: 600; cursor: pointer;
          transition: background 0.2s ease; font-family: 'Inter', sans-serif;
        ">Cancel</button>
      `;

      modal.appendChild(modalContent);
      document.body.appendChild(modal);

      // Close modal function
      window.closeModal = () => {
        if (modal.parentNode) {
          modal.parentNode.removeChild(modal);
        }
      };

      // MetaMask connection function
      window.connectMetaMask = async () => {
        try {
          if (!window.ethereum) {
            alert('MetaMask not installed! Please install MetaMask extension.');
            window.open('https://metamask.io/download/', '_blank');
            return;
          }

          console.log('Connecting to MetaMask...');
          const accounts = await window.ethereum.request({ 
            method: 'eth_requestAccounts' 
          });
          
          if (accounts && accounts.length > 0) {
            const account = accounts[0];
            console.log('Connected account:', account);
            
            // Get network info
            const chainId = await window.ethereum.request({ method: 'eth_chainId' });
            console.log('Chain ID:', chainId);
            
            // Get balance
            const balance = await window.ethereum.request({
              method: 'eth_getBalance',
              params: [account, 'latest']
            });
            
            // Convert balance from hex to decimal and then to ETH
            const balanceInWei = parseInt(balance, 16);
            const balanceInEth = (balanceInWei / Math.pow(10, 18)).toFixed(4);
            
            // Update header button with detailed info
            const headerBtn = document.getElementById('headerWalletBtn');
            if (headerBtn) {
              const shortAddress = account.slice(0, 6) + '...' + account.slice(-4);
              headerBtn.innerHTML = `
                <div style="display: flex; align-items: center; gap: 8px;">
                  <span style="font-size: 16px;">🦊</span>
                  <div style="text-align: left; line-height: 1.2;">
                    <div style="font-size: 12px; font-weight: 600;">${shortAddress}</div>
                    <div style="font-size: 10px; opacity: 0.8;">${balanceInEth} ETH</div>
                  </div>
                </div>
              `;
              headerBtn.style.background = 'rgba(255, 255, 255, 0.1)';
              headerBtn.style.border = '2px solid rgba(255, 255, 255, 0.2)';
              // Update click handler for disconnect
              headerBtn.onclick = () => {
                if (confirm('Disconnect wallet?')) {
                  window.disconnectWallet();
                }
              };
            }
            
            // Store connection info globally
            window.walletInfo = {
              address: account,
              balance: balanceInEth,
              chainId: chainId,
              type: 'metamask'
            };
            
            alert(`MetaMask connected successfully!\nAddress: ${shortAddress}\nBalance: ${balanceInEth} ETH`);
          } else {
            throw new Error('No accounts returned from MetaMask');
          }
        } catch (error) {
          console.error('MetaMask connection error:', error);
          if (error.code === 4001) {
            alert('Connection rejected by user');
          } else {
            alert('Failed to connect MetaMask: ' + error.message);
          }
        }
      };

      // Disconnect wallet function
      window.disconnectWallet = () => {
        window.walletInfo = null;
        const headerBtn = document.getElementById('headerWalletBtn');
        if (headerBtn) {
          headerBtn.innerHTML = '<span style="font-size: 16px;">🌈</span> <span>Connect Wallet</span>';
          headerBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
          headerBtn.style.border = 'none';
          headerBtn.onclick = () => window.openWalletModal();
        }
        alert('Wallet disconnected successfully!');
      };

      // WalletConnect function
      window.connectWalletConnect = () => {
        alert('WalletConnect integration coming soon!\n\nFor now, please use:\n- MetaMask browser extension\n- Coinbase Wallet extension\n- Or Auto Detect for other wallets');
      };

      // Coinbase Wallet function
      window.connectCoinbase = async () => {
        try {
          if (window.coinbaseWalletExtension) {
            const accounts = await window.coinbaseWalletExtension.request({ 
              method: 'eth_requestAccounts' 
            });
            alert('Coinbase Wallet connected: ' + accounts[0]);
          } else {
            alert('Coinbase Wallet not detected!\n\nPlease install Coinbase Wallet extension or use the mobile app with WalletConnect.');
            window.open('https://www.coinbase.com/wallet', '_blank');
          }
        } catch (error) {
          alert('Failed to connect Coinbase Wallet: ' + error.message);
        }
      };

      // Auto detect function
      window.detectAndConnect = async () => {
        const wallets = [];
        
        if (window.ethereum) {
          if (window.ethereum.isMetaMask) wallets.push('🦊 MetaMask');
          if (window.ethereum.isCoinbaseWallet) wallets.push('🪙 Coinbase');
          if (window.ethereum.isRabby) wallets.push('🐰 Rabby');
          if (window.ethereum.isTrust) wallets.push('🛡️ Trust Wallet');
          if (window.ethereum.isBraveWallet) wallets.push('🦁 Brave Wallet');
        }
        
        if (window.tronWeb) wallets.push('🔥 TronLink');
        if (window.solana) wallets.push('🔮 Phantom');
        
        if (wallets.length === 0) {
          alert('No wallets detected!\n\nPlease install one of these:\n- MetaMask\n- Coinbase Wallet\n- Trust Wallet\n- Brave Wallet');
          window.open('https://metamask.io/download/', '_blank');
        } else {
          const walletList = wallets.join('\n- ');
          alert(`Detected wallets:\n- ${walletList}\n\nClick MetaMask to connect with the primary wallet.`);
          // Auto connect to primary wallet
          window.connectMetaMask();
        }
      };

      // Close when clicking outside
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          window.closeModal();
        }
      });
    };

    // Initialize app when DOM is loaded
    window.addEventListener('DOMContentLoaded', async function() {
      try {
        const app = new SendwiseApp();
        window.sendwiseApp = app; // Global reference for debugging
        
        // Make wallet manager globally accessible
        window.walletManager = app.getWalletManager();
        
        console.log('App initialized, openWalletModal available:', typeof window.openWalletModal);
        console.log('WalletManager globally available:', !!window.walletManager);
      } catch (error) {
        console.error('Failed to initialize Sendwise app:', error);
        document.getElementById('loading').classList.add('hidden');
      }
    });
  </script>
</body>
</html>
