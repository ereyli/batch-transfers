<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, shrink-to-fit=no">
  <title>Sendwise - Share Cast</title>
  
  <!-- Farcaster Meta Tags -->
  <meta name="fc:frame" content="vNext">
  <meta name="fc:frame:image" content="https://www.sendwise.xyz/.well-known/image.png">
  <meta name="fc:frame:button:1" content="üöÄ Start Batch Transfer">
  <meta name="fc:frame:post_url" content="https://www.sendwise.xyz">
  <meta name="fc:frame:input:text" content="Enter recipient addresses...">
  <meta name="farcaster_manifest" content="https://www.sendwise.xyz/.well-known/farcaster.json">
  
  <!-- Open Graph -->
  <meta property="og:title" content="Sendwise - Batch Transfer from Cast">
  <meta property="og:description" content="Extract addresses from cast and send batch transfers">
  <meta property="og:image" content="https://www.sendwise.xyz/.well-known/image.png">
  
  <!-- Icon -->
  <link rel="icon" href="https://www.sendwise.xyz/.well-known/icon.png">
  
  <!-- Styles -->
  <link rel="stylesheet" href="styles/main.css">
  
  <!-- Farcaster SDK -->
  <script type="module" src="https://cdn.jsdelivr.net/npm/@farcaster/frame-sdk@latest/dist/sdk.js" defer></script>
  
  <!-- External Dependencies -->
  <script src="https://cdn.ethers.io/lib/ethers-5.0.umd.min.js"></script>
  
  <style>
    .cast-context {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
    }
    
    .cast-author {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 15px;
    }
    
    .cast-author img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 2px solid #6366f1;
    }
    
    .cast-text {
      background: rgba(0,0,0,0.3);
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      font-family: monospace;
      font-size: 14px;
      line-height: 1.5;
    }
    
    .extracted-addresses {
      margin: 20px 0;
    }
    
    .address-item {
      background: rgba(16,185,129,0.1);
      border: 1px solid rgba(16,185,129,0.3);
      border-radius: 8px;
      padding: 12px;
      margin: 8px 0;
      font-family: monospace;
      font-size: 13px;
    }
    
    .share-header {
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      text-align: center;
    }
    
    .import-btn {
      background: #6366f1;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      margin: 10px 5px;
    }
    
    .import-btn:hover {
      background: #5856eb;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-overlay">
      <div class="loading-content">
        <div class="logo-container">
          <img src="https://www.sendwise.xyz/.well-known/logo.png" alt="Sendwise Logo" />
        </div>
        <h2>Loading Shared Cast...</h2>
        <div class="loading-spinner"></div>
      </div>
    </div>

    <!-- Main Content -->
    <div id="mainContent" style="display: none;">
      <!-- Header -->
      <div class="share-header">
        <h1>üì§ Cast Shared to Sendwise</h1>
        <p>Extract addresses and create batch transfers</p>
      </div>

      <!-- Cast Context -->
      <div id="castContext" class="cast-context" style="display: none;">
        <div class="cast-author" id="castAuthor">
          <!-- Author info will be populated -->
        </div>
        <div class="cast-text" id="castText">
          <!-- Cast text will be populated -->
        </div>
      </div>

      <!-- Extracted Addresses -->
      <div id="extractedSection" style="display: none;">
        <h3>üéØ Extracted Addresses:</h3>
        <div id="extractedAddresses" class="extracted-addresses">
          <!-- Extracted addresses will appear here -->
        </div>
        <div style="text-align: center; margin: 20px 0;">
          <button class="import-btn" onclick="importAddresses()">
            üì• Import to Batch Transfer
          </button>
          <button class="import-btn" onclick="goToMain()">
            üöÄ Go to Main App
          </button>
        </div>
      </div>

      <!-- No Addresses Found -->
      <div id="noAddressesSection" style="display: none; text-align: center; padding: 40px;">
        <h3>üîç No Addresses Found</h3>
        <p>This cast doesn't contain any Ethereum addresses.</p>
        <button class="import-btn" onclick="goToMain()">
          üöÄ Go to Main App
        </button>
      </div>

      <!-- Network Selection -->
      <div class="supported-networks" id="networkTags" style="display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; margin: 20px 0;">
        <button class="network-tag" data-chain="8453">Base</button>
        <button class="network-tag" data-chain="10">Optimism</button>
        <button class="network-tag" data-chain="42161">Arbitrum</button>
        <button class="network-tag" data-chain="1868">Soneium</button>
        <button class="network-tag" data-chain="130">Unichain</button>
        <button class="network-tag" data-chain="57073">Ink</button>
      </div>

      <!-- Transfer Form (will be shown after import) -->
      <div id="transferForm" style="display: none;">
        <h3>üí∏ Batch Transfer</h3>
        <div class="form-section">
          <label>Amount per address (ETH):</label>
          <input type="number" id="batchAmount" class="form-input" placeholder="0.01" step="0.001" min="0.001">
        </div>
        <div class="recipients-container" id="recipientsContainer">
          <!-- Recipients will be populated -->
        </div>
        <button id="sendBtn" class="cta-button" onclick="sendBatch()" style="margin-top: 20px;">
          üöÄ Send Batch Transfer
        </button>
      </div>
    </div>
  </div>

  <script>
    let sharedCast = null;
    let extractedAddresses = [];
    let selectedChainId = 8453; // Default to Base

    // Extract URL parameters
    function getUrlParams() {
      const urlParams = new URLSearchParams(window.location.search);
      return {
        castHash: urlParams.get('castHash'),
        castFid: urlParams.get('castFid'),
        viewerFid: urlParams.get('viewerFid')
      };
    }

    // Extract Ethereum addresses from text
    function extractEthereumAddresses(text) {
      const ethAddressRegex = /0x[a-fA-F0-9]{40}/g;
      const matches = text.match(ethAddressRegex) || [];
      // Remove duplicates and validate
      const uniqueAddresses = [...new Set(matches)];
      return uniqueAddresses.filter(addr => {
        // Basic validation - starts with 0x and is 42 chars
        return addr.length === 42 && addr.startsWith('0x');
      });
    }

    // Display cast context
    function displayCastContext(cast) {
      const castContext = document.getElementById('castContext');
      const castAuthor = document.getElementById('castAuthor');
      const castText = document.getElementById('castText');

      if (cast) {
        // Author info
        castAuthor.innerHTML = `
          <img src="${cast.author.pfpUrl || 'https://www.sendwise.xyz/.well-known/icon.png'}" alt="Author PFP" />
          <div>
            <div style="font-weight: bold; color: #6366f1;">@${cast.author.username || 'unknown'}</div>
            <div style="font-size: 12px; opacity: 0.7;">${cast.author.displayName || ''}</div>
          </div>
        `;

        // Cast text
        castText.textContent = cast.text || 'No text content';
        
        castContext.style.display = 'block';

        // Extract addresses
        extractedAddresses = extractEthereumAddresses(cast.text || '');
        displayExtractedAddresses();
      }
    }

    // Display extracted addresses
    function displayExtractedAddresses() {
      const extractedSection = document.getElementById('extractedSection');
      const noAddressesSection = document.getElementById('noAddressesSection');
      const extractedContainer = document.getElementById('extractedAddresses');

      if (extractedAddresses.length > 0) {
        extractedContainer.innerHTML = extractedAddresses.map((addr, i) => `
          <div class="address-item">
            <strong>Address ${i + 1}:</strong> ${addr}
          </div>
        `).join('');
        
        extractedSection.style.display = 'block';
        noAddressesSection.style.display = 'none';
      } else {
        extractedSection.style.display = 'none';
        noAddressesSection.style.display = 'block';
      }
    }

    // Import addresses to transfer form
    function importAddresses() {
      if (extractedAddresses.length === 0) return;

      const transferForm = document.getElementById('transferForm');
      const recipientsContainer = document.getElementById('recipientsContainer');

      // Create recipient rows
      recipientsContainer.innerHTML = extractedAddresses.map((addr, i) => `
        <div class="recipient-row">
          <div class="form-group">
            <label>Recipient ${i + 1}:</label>
            <input type="text" class="form-input recipient-address" value="${addr}" readonly>
          </div>
          <div class="form-group">
            <label>Amount (ETH):</label>
            <input type="number" class="form-input recipient-amount" placeholder="0.01" step="0.001" min="0.001">
          </div>
        </div>
      `).join('');

      transferForm.style.display = 'block';
      
      // Scroll to form
      transferForm.scrollIntoView({ behavior: 'smooth' });
    }

    // Go to main app
    function goToMain() {
      window.location.href = '/';
    }

    // Send batch transfer (simplified version)
    async function sendBatch() {
      const batchAmount = document.getElementById('batchAmount').value;
      const recipientAmounts = Array.from(document.querySelectorAll('.recipient-amount')).map(input => input.value);

      if (!batchAmount && !recipientAmounts.some(amount => amount)) {
        alert('Please enter amount(s) for the transfer');
        return;
      }

      // Use batch amount for all if specified, otherwise use individual amounts
      const recipients = extractedAddresses.map((addr, i) => ({
        address: addr,
        amount: batchAmount || recipientAmounts[i] || '0'
      })).filter(r => parseFloat(r.amount) > 0);

      if (recipients.length === 0) {
        alert('Please enter valid amounts');
        return;
      }

      console.log('Batch transfer data:', {
        network: selectedChainId,
        recipients: recipients
      });

      alert(`Ready to send ${recipients.length} transfers on chain ${selectedChainId}!\\n\\nThis would redirect to main app for actual execution.`);
      
      // Store data and redirect to main app
      localStorage.setItem('pendingBatchTransfer', JSON.stringify({
        chainId: selectedChainId,
        recipients: recipients,
        source: 'cast_share'
      }));
      
      goToMain();
    }

    // Network selection
    function setupNetworkSelection() {
      const tags = document.querySelectorAll('.network-tag');
      
      tags.forEach(tag => {
        tag.addEventListener('click', () => {
          selectedChainId = Number(tag.dataset.chain);
          
          // Update visual selection
          tags.forEach(t => t.classList.remove('selected'));
          tag.classList.add('selected');
          
          console.log('Selected network:', selectedChainId);
        });
      });

      // Default selection
      if (tags.length > 0) {
        tags[0].classList.add('selected');
      }
    }

    // Initialize share context
    async function initializeShareContext() {
      console.log('Initializing share context...');
      
      // Get URL parameters first (available immediately)
      const urlParams = getUrlParams();
      console.log('URL Parameters:', urlParams);

      if (urlParams.castHash) {
        console.log('Cast shared via URL parameters:', urlParams);
        
        // Create basic cast object from URL params
        const basicCast = {
          hash: urlParams.castHash,
          author: {
            fid: urlParams.castFid,
            username: `fid:${urlParams.castFid}`,
            displayName: `User ${urlParams.castFid}`
          },
          text: 'Loading cast content...'
        };
        
        displayCastContext(basicCast);
      }

      // Try to get enhanced data from SDK
      try {
        await waitForFarcasterSDK();
        
        if (window.farcasterSDK && window.farcasterSDK.context) {
          if (window.farcasterSDK.context.location?.type === 'cast_share') {
            const sdkCast = window.farcasterSDK.context.location.cast;
            console.log('Enhanced cast data from SDK:', sdkCast);
            
            sharedCast = sdkCast;
            displayCastContext(sdkCast);
          }
        }
      } catch (error) {
        console.log('Could not get enhanced cast data:', error);
      }

      // Hide loading screen
      document.getElementById('loadingScreen').style.display = 'none';
      document.getElementById('mainContent').style.display = 'block';
    }

    // Wait for Farcaster SDK
    async function waitForFarcasterSDK() {
      return new Promise((resolve, reject) => {
        let attempts = 0;
        const maxAttempts = 50;
        
        function checkSDK() {
          if (window.FrameSDK || window.farcaster || window.farcasterSDK) {
            window.farcasterSDK = window.FrameSDK || window.farcaster || window.farcasterSDK;
            console.log('Farcaster SDK available for share context');
            resolve(window.farcasterSDK);
            return;
          }
          
          attempts++;
          if (attempts >= maxAttempts) {
            reject(new Error('SDK not available'));
            return;
          }
          
          setTimeout(checkSDK, 100);
        }
        
        checkSDK();
      });
    }

    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
      console.log('Share page initializing...');
      setupNetworkSelection();
      initializeShareContext();
    });
  </script>
</body>
</html>
